---
title: CSAPP 3nd - æ±‡ç¼–ä¸ŽæŽ§åˆ¶
description: "è¿™ç¯‡æ–‡ç« ä»‹ç»äº†CSAPPç¬¬ä¸‰ç« çš„æ±‡ç¼–ä¸ŽæŽ§åˆ¶å†…å®¹ï¼ŒåŒ…æ‹¬å¯„å­˜å™¨ç±»åž‹ã€æ¡ä»¶ç ã€æ¡ä»¶åˆ†æ”¯ã€å¾ªçŽ¯ã€switchè¯­å¥ç­‰ã€‚"
publishDate: "7 Apr 2025"
updatedDate: "7 Apr 2025"
tags: ["CSAPP", "assembly", "control flow", "computer science"]
---

## æ±‡ç¼–

### å¯„å­˜å™¨ç±»åž‹

- 64ä½ä¸º`r`
- 32ä½ä¸º`e`

| æ±‡ç¼–æœ¯è¯­ | ä½æ•° | å­—èŠ‚æ•° | ç¤ºä¾‹å¯„å­˜å™¨             |
| -------- | ---- | ------ | ---------------------- |
| byte     | 8    | 1      | `%al`, `%bl`, `%r8b`   |
| word     | 16   | 2      | `%ax`, `%bx`, `%r8w`   |
| long     | 32   | 4      | `%eax`, `%ebx`, `%r8d` |
| quad     | 64   | 8      | `%rax`, `%rbx`, `%r8`  |

### Control

#### Condition codes

- æ¡ä»¶ç 
- `cmpq`
- `setX`
  åŸºäºŽæ¡ä»¶ç çš„å€¼å°†å•ä¸ªå¯„å­˜å™¨çš„å•ä¸ªå­—èŠ‚è®¾ç½®ä¸º0æˆ–1ï¼ˆå–å¯¹åº”æ¡ä»¶ç ä½Žä½çš„æ•°å­—ä½œä¸ºç›®æ ‡å¯„å­˜å™¨çš„ä½Žä½ï¼Œç„¶åŽå°†å‰©ä½™7ä½ç½®ä¸º0ï¼‰
- `movzbl`
  x86-64æœºå™¨ä¸Šï¼Œç»“æžœä¸º32ä½çš„æ•°å­—ä¼šè‡ªåŠ¨å°†é«˜ä½çš„32ä½æ‰©å±•ä¸º0ï¼Œä½†æ˜¯å¯¹äºŽä½ŽäºŽ4å­—èŠ‚çš„ç»“æžœå°±ä¸ä¼šè¿›è¡Œæ‰©å±•ï¼Œæ‰€ä»¥ä¼šæœ‰`movzbl`æŒ‡ä»¤æ¥å¯¹å•å­—èŠ‚ï¼ˆä¸¤ä¸ªå­—èŠ‚ä¸º`movzwl`ï¼‰çš„æ•°å­—è¿›è¡Œæ‰©å±•åˆ°å››ä¸ªå­—èŠ‚ï¼ˆzä»£è¡¨zeroï¼Œbä»£è¡¨byteï¼Œlä»£è¡¨longï¼‰

#### Conditional branches

**`jX`æŒ‡ä»¤**

| æŒ‡ä»¤ | æ¡ä»¶æè¿°             | å¯¹åº” setX | æ ‡å¿—æ¡ä»¶          | ç”¨äºŽæ¯”è¾ƒç±»åž‹    |
| ---- | -------------------- | --------- | ----------------- | --------------- |
| je   | ç›¸ç­‰ï¼ˆequalï¼‰        | sete      | ZF = 1            | æœ‰ç¬¦å· / æ— ç¬¦å· |
| jne  | ä¸ç›¸ç­‰ï¼ˆnot equalï¼‰  | setne     | ZF = 0            | æœ‰ç¬¦å· / æ— ç¬¦å· |
| jg   | å¤§äºŽï¼ˆsignedï¼‰       | setg      | ZF = 0 ä¸” SF = OF | æœ‰ç¬¦å·          |
| jge  | å¤§äºŽç­‰äºŽï¼ˆsignedï¼‰   | setge     | SF = OF           | æœ‰ç¬¦å·          |
| jl   | å°äºŽï¼ˆsignedï¼‰       | setl      | SF â‰  OF           | æœ‰ç¬¦å·          |
| jle  | å°äºŽç­‰äºŽï¼ˆsignedï¼‰   | setle     | ZF = 1 æˆ– SF â‰  OF | æœ‰ç¬¦å·          |
| ja   | é«˜äºŽï¼ˆunsignedï¼‰     | seta      | CF = 0 ä¸” ZF = 0  | æ— ç¬¦å·          |
| jae  | é«˜äºŽç­‰äºŽï¼ˆunsignedï¼‰ | setae     | CF = 0            | æ— ç¬¦å·          |
| jb   | ä½ŽäºŽï¼ˆunsignedï¼‰     | setb      | CF = 1            | æ— ç¬¦å·          |
| jbe  | ä½ŽäºŽç­‰äºŽï¼ˆunsignedï¼‰ | setbe     | CF = 1 æˆ– ZF = 1  | æ— ç¬¦å·          |
| js   | è´Ÿæ•°ï¼ˆè´Ÿå·ï¼‰         | sets      | SF = 1            | é€šç”¨            |
| jns  | éžè´Ÿ                 | setns     | SF = 0            | é€šç”¨            |
| jo   | æº¢å‡ºï¼ˆoverflowï¼‰     | seto      | OF = 1            | é€šç”¨            |
| jno  | æ— æº¢å‡º               | setno     | OF = 0            | é€šç”¨            |

ç”Ÿæˆè·³è½¬æ±‡ç¼–è¯­è¨€çš„gccæŒ‡ä»¤(è¿™ä¸ªæŒ‡ä»¤çš„æ„æ€æ˜¯ç¼–è¯‘æˆæ±‡ç¼–è¯­è¨€ï¼Œ-Ogè¡¨ç¤ºä¼˜åŒ–çº§åˆ«ä¸º0ï¼Œ-Sè¡¨ç¤ºåªç¼–è¯‘æˆæ±‡ç¼–è¯­è¨€ï¼Œä¸é“¾æŽ¥ï¼Œ-fno-if-conversionè¡¨ç¤ºä¸ä½¿ç”¨æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤)ã€‚
```bash
gcc -Og -S -fno-if-conversion control.c
```
#### ðŸ“˜ å‡½æ•°ï¼šè®¡ç®—ä¸¤ä¸ª long æ•´æ•°çš„å·®çš„ç»å¯¹å€¼

#### C è¯­è¨€ä»£ç ï¼š

```c
long absdiff(long x, long y) {
    long result;
    if (x > y)
        result = x - y;
    else
        result = y - x;
    return result;
}
```
æ±‡ç¼–ä»£ç ï¼ˆAT&T è¯­æ³•ï¼‰ï¼š
```asm
absdiff:
    cmpq    %rsi, %rdi        # æ¯”è¾ƒ x : y ï¼ˆx > y?ï¼‰
    jle     .L4               # å¦‚æžœ x <= yï¼Œè·³åˆ° .L4
    movq    %rdi, %rax        # x > y: æŠŠ y æ”¾å…¥ rax
    subq    %rsi, %rax        # rax = y - x
    ret

.L4:                          # x <= y åˆ†æ”¯
    movq    %rsi, %rax        # æŠŠ x æ”¾å…¥ rax
    subq    %rdi, %rax        # rax = x - y
    ret
```
å¦‚æžœä½¿ç”¨äº†æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤ï¼Œé‚£ä¹ˆä¸Šé¢çš„çš„ä»£ç å°±ä¼šå˜æˆï¼š
```asm
absdiff:
    movq   %rdi, %rax        # æŠŠ x æ”¾å…¥ rax
    subq   %rsi, %rax        # rax = x - y 
    movq   %rsi, %rdx        # æŠŠ y æ”¾å…¥ rdx
    subq   %rdi, %rdx        # rdx = y - x
    cmopq  %rsi, %rdi        # æ¯”è¾ƒ x : y ï¼ˆx > y?ï¼‰
    cmovle %rdx, %rax        # å¦‚æžœ x <= yï¼Œrax = x - y
```
æ¡ä»¶ç§»åŠ¨ä¼šæå‰è®¡ç®—å‡ºæ‰€æœ‰çš„ç»“æžœï¼Œç„¶åŽæ ¹æ®æ¡ä»¶ç æ¥å†³å®šä½¿ç”¨å“ªä¸ªç»“æžœã€‚
- å¯¹äºŽç®€å•åœ°åˆ†æ”¯ï¼Œä½¿ç”¨æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤ä¼šæ›´å¿«ï¼Œä½†æ˜¯å¯¹äºŽå¤æ‚çš„åˆ†æ”¯ï¼Œä½¿ç”¨æ¡ä»¶ç§»åŠ¨æŒ‡ä»¤ä¼šæ›´æ…¢ã€‚
- å¯¹äºŽç©ºæŒ‡é’ˆè¿™ç§æƒ…å†µï¼Œä¸èƒ½ä½¿ç”¨æ¡ä»¶ç§»åŠ¨ï¼Œä¼šå¯¼è‡´ç¨‹åºå¼‚å¸¸ã€‚
  ```
    val = p ? *p:0; // è¿™é‡Œçš„æ¡ä»¶ç§»åŠ¨ä¼šå¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸
  ```
- å¯¹äºŽå‰ä¸€ä¸ªåˆ†æ”¯å¸¦æœ‰å‰¯ä½œç”¨çš„æƒ…å†µï¼Œä¹Ÿä¸èƒ½ä½¿ç”¨æ¡ä»¶æŒ‡ä»¤
  ```
    var = x ? x+=3:x*=7; 
  ```
#### Loops
åœ¨æ±‡ç¼–å±‚çº§ï¼Œdo-whileå¾ªçŽ¯æ˜¯å¦å¤–ä¸¤ç§å¾ªçŽ¯çš„åŸºç¡€ç»“æž„ï¼Œwhileå’Œforå¾ªçŽ¯éƒ½å¯ä»¥ç”¨do-whileå¾ªçŽ¯æ¥å®žçŽ°ã€‚
```asm
do_while:
    .L2:
        # å¾ªçŽ¯ä½“
        # ...
        # åˆ¤æ–­æ¡ä»¶
        cmpq    $0, %rdi       # æ¯”è¾ƒæ¡ä»¶
        jne     .L2            # å¦‚æžœæ¡ä»¶ä¸ä¸º0ï¼Œè·³åˆ° .L2
```
```asm
while:
    .L3:
        # åˆ¤æ–­æ¡ä»¶
        cmpq    $0, %rdi       # æ¯”è¾ƒæ¡ä»¶
        je      .L4            # å¦‚æžœæ¡ä»¶ä¸º0ï¼Œè·³åˆ° .L4
        # å¾ªçŽ¯ä½“
        # ...
        jmp     .L3            # è·³åˆ° .L3
.L4:
```
```asm
for:
    # åˆå§‹åŒ–
    movq    $0, %rdi         # åˆå§‹åŒ–æ¡ä»¶
    .L5:
        # åˆ¤æ–­æ¡ä»¶
        cmpq    $10, %rdi      # æ¯”è¾ƒæ¡ä»¶
        jge     .L6            # å¦‚æžœæ¡ä»¶å¤§äºŽç­‰äºŽ10ï¼Œè·³åˆ° .L6
        # å¾ªçŽ¯ä½“
        # ...
        incq    %rdi           # æ¡ä»¶è‡ªå¢ž1
        jmp     .L5            # è·³åˆ° .L5
.L6:
```
#### Switch Statements
#### âœ… switch ä¸­ case å¸¸é‡çš„è§„åˆ™æ€»ç»“ï¼š

| è¦æ±‚                 | è¯´æ˜Ž                                       |
|----------------------|--------------------------------------------|
| å¿…é¡»æ˜¯å¸¸é‡è¡¨è¾¾å¼     | ç¼–è¯‘æ—¶èƒ½ç¡®å®šçš„æ•´æ•°ï¼Œå¦‚ `1`, `3+4`, `#define A 5` |
| ä¸èƒ½é‡å¤             | æ¯ä¸ª case å€¼å¿…é¡»å”¯ä¸€                        |
| ä¸è¦æ±‚é€’å¢žæˆ–è¿žç»­     | case å¯ä»¥æ— åºã€ç¨€ç–ï¼Œé¡ºåºæ— å…³                |
| ç±»åž‹å¿…é¡»æ˜¯æ•´åž‹       | æ”¯æŒ int, char, short, enum ç­‰ï¼Œä¸æ”¯æŒ floatã€æŒ‡é’ˆ |
### ðŸ” switch çš„è·³è½¬è¡¨åŽŸç†

- è·³è½¬è¡¨ï¼ˆjump tableï¼‰æ˜¯ä¸€ç§å°† case å¸¸é‡å€¼æ˜ å°„ä¸º **ä»£ç åœ°å€** çš„æ•°ç»„ã€‚
- ç¼–è¯‘å™¨ä½¿ç”¨ `jmp *table(x)` å®žçŽ° O(1) å¤šåˆ†æ”¯è·³è½¬ã€‚
- åªæœ‰å½“ case å€¼ **è¿žç»­ä¸”æ•°é‡è¾ƒå¤š** æ—¶æ‰ä¼šå¯ç”¨ã€‚

#### æ±‡ç¼–ç»“æž„æ¦‚è§ˆï¼š

```asm
cmp $max, %x
ja .Ldefault
jmp *.Ltable(,%x,8)

.Ltable:
    .quad .Lcase0
    .quad .Lcase1
    ...
```
### ðŸ“˜ æŒ‡ä»¤å«ä¹‰ï¼ˆswitch è·³è½¬è¡¨ç›¸å…³ï¼‰

| æŒ‡ä»¤ | ä½œç”¨ | å«ä¹‰è§£é‡Š |
|------|------|----------|
| `ja label` | æ¡ä»¶è·³è½¬ï¼ˆæ— ç¬¦å·ï¼‰ | å¦‚æžœå‰é¢ `cmp` ä¸­æ— ç¬¦å·å¤§äºŽæˆç«‹ï¼Œè·³è½¬åˆ° label |
| `jmp *%rdi` | é—´æŽ¥è·³è½¬ | è·³è½¬åˆ° `%rdi` å¯„å­˜å™¨ä¸­å­˜æ”¾çš„åœ°å€æ‰§è¡Œ |
| `jmp *.Ljump_table(,%rdi,8)` | é—´æŽ¥è·³è½¬ | è·³è½¬åˆ°è·³è½¬è¡¨ä¸­ç¬¬ `%rdi` é¡¹æ‰€å­˜æ”¾çš„åœ°å€æ‰§è¡Œ |

## ðŸ§  GDB `x` å‘½ä»¤ï¼ˆexamine memoryï¼‰ç”¨æ³•é€ŸæŸ¥è¡¨

GDB çš„ `x` å‘½ä»¤ç”¨äºŽæŸ¥çœ‹ä»»æ„å†…å­˜åœ°å€çš„å†…å®¹ï¼Œæ”¯æŒä»¥å¤šç§æ ¼å¼å’Œå•ä½æ˜¾ç¤ºï¼Œæ˜¯è°ƒè¯•æ±‡ç¼–ã€æŒ‡é’ˆã€æ ˆå†…å®¹çš„é‡è¦å·¥å…·ã€‚

### ðŸ§¾ åŸºæœ¬è¯­æ³•

x/[ä¸ªæ•°] [æ ¼å¼] [å•ä½] åœ°å€

- `ä¸ªæ•°`ï¼šæ˜¾ç¤ºå‡ ä¸ªå•å…ƒï¼ˆé»˜è®¤1ï¼‰
- `æ ¼å¼`ï¼šæ˜¾ç¤ºæ ¼å¼ï¼ˆhexã€decã€stringç­‰ï¼‰
- `å•ä½`ï¼šæ¯ä¸ªå•å…ƒçš„å¤§å°ï¼ˆbyteã€wordç­‰ï¼‰

---

### ðŸ“Œ å¸¸ç”¨æ ¼å¼ç¬¦å·

| æ ¼å¼ç¬¦ | å«ä¹‰               | ç¤ºä¾‹        |
| ------ | ------------------ | ----------- |
| `x`    | åå…­è¿›åˆ¶ï¼ˆhexï¼‰    | `x/4x $rsp` |
| `d`    | åè¿›åˆ¶ï¼ˆsignedï¼‰   | `x/4d addr` |
| `u`    | åè¿›åˆ¶ï¼ˆunsignedï¼‰ | `x/4u addr` |
| `t`    | äºŒè¿›åˆ¶             | `x/4t addr` |
| `f`    | æµ®ç‚¹æ•°             | `x/4f addr` |
| `s`    | å­—ç¬¦ä¸²ï¼ˆC é£Žæ ¼ï¼‰   | `x/s $rsi`  |
| `i`    | æ±‡ç¼–æŒ‡ä»¤ï¼ˆåæ±‡ç¼–ï¼‰ | `x/i $rip`  |

---

### ðŸ“Œ å¸¸ç”¨å•ä½ç¬¦å·

| å•ä½ç¬¦ | å•å…ƒå¤§å° | è¯´æ˜Ž                |
| ------ | -------- | ------------------- |
| `b`    | 1 å­—èŠ‚   | byte                |
| `h`    | 2 å­—èŠ‚   | halfwordï¼ˆå°‘ç”¨ï¼‰    |
| `w`    | 4 å­—èŠ‚   | wordï¼ˆ32 ä½ï¼‰       |
| `g`    | 8 å­—èŠ‚   | giant wordï¼ˆ64 ä½ï¼‰ |

---

### ðŸ” å¸¸ç”¨å‘½ä»¤ç¤ºä¾‹

| å‘½ä»¤           | å«ä¹‰                                          |
| -------------- | --------------------------------------------- |
| `x/x 0x601040` | æŸ¥çœ‹åœ°å€ `0x601040` çš„ 1 ä¸ª wordï¼ˆ4Bï¼‰        |
| `x/4x $rsp`    | æŸ¥çœ‹ `$rsp` å¼€å§‹çš„ 4 ä¸ª wordï¼ˆå…±16å­—èŠ‚ï¼‰      |
| `x/gx $rbp`    | æŸ¥çœ‹ `$rbp` æŒ‡å‘çš„ 1 ä¸ª giant wordï¼ˆ64 ä½ï¼‰   |
| `x/8gx $rsp`   | è¿žç»­æŸ¥çœ‹ 8 ä¸ª 64 ä½å€¼ï¼ˆå¸¸ç”¨äºŽæŸ¥çœ‹æ ˆï¼‰         |
| `x/4xb $rax`   | æŸ¥çœ‹ `$rax` æŒ‡å‘åœ°å€çš„ 4 ä¸ªå­—èŠ‚ï¼ˆé€å­—èŠ‚æ˜¾ç¤ºï¼‰ |
| `x/s 0x6037d0` | æŸ¥çœ‹åœ°å€å¤„çš„ C å­—ç¬¦ä¸²                         |
| `x/i $rip`     | æŸ¥çœ‹å½“å‰æŒ‡ä»¤ï¼ˆåæ±‡ç¼–ï¼‰                        |

---

### ðŸŽ¯ å®žç”¨æŠ€å·§

- ä½¿ç”¨ `$` å¯å¼•ç”¨å¯„å­˜å™¨åï¼šå¦‚ `$rsp`ã€`$rbp`ã€`$rax`
- å°ç«¯åºï¼š`x86_64` æž¶æž„ä¸‹å†…å­˜æŒ‰å°ç«¯åºå­˜å‚¨
- å¯ç»“åˆ `/b` æŸ¥çœ‹å­—èŠ‚çº§åˆ«æ•°æ®ç»“æž„ï¼ˆå¦‚ç»“æž„ä½“ã€æ ˆå¸§ç­‰ï¼‰

---

### ðŸ§° æŽ¨èç»„åˆæ“ä½œ

```gdb
x/gx $rsp         # æ ˆé¡¶64ä½
x/8x $rsp         # æ ˆä¸Šè¿žç»­4å­—ï¼ˆ16Bï¼‰
x/4xb $rax        # æŸ¥çœ‹å¯„å­˜å™¨æŒ‡å‘åœ°å€çš„4å­—èŠ‚ï¼ˆå­—èŠ‚çº§ï¼‰
x/s $rsi          # æ‰“å°å­—ç¬¦ä¸²æŒ‡é’ˆçš„å†…å®¹
x/i $rip          # æŸ¥çœ‹å½“å‰æ‰§è¡ŒæŒ‡ä»¤
```